<div class="container">
	{{!-- Character Information --}}
	<div class="info">
		<div class="player">
			<span>Player Name</span>
			<input type="text" name="attr_playerName" placeholder="Enter Your Name">
		</div>
		<div class="name">
			<span>Character Name</span>
			<input type="text" name="attr_character_name" placeholder="Enter Your Character's Name">
		</div>
		<div class="class">
			<span>Class & Subclass</span>
			<input type="text" name="attr_class" placeholder="Class - Subclass">
		</div>
		<div class="ancestry">
			<span>Ancestry & Background</span>
			<input type="text" name="attr_ancestry" placeholder="Ancestry & Background">
		</div>
		<div class="level">
			<span>Level</span>
			<input type="number" name="attr_level" value="1" min="1">
		</div>
		<div class="cm">
			<span>Combat Mastery</span>
			<input type="text" name="attr_combatMastery" value="1" readonly>
		</div>
	</div>

	{{!-- Character Stats and Skills --}}
	<div class="stats">
		{{#each skillsList as |skills|}}
		{{#if @key}}
		<div class="{{@key}}-stat">
			<span>{{truncate (uppercase @key) 3}}</span>
			<input type="number" name="attr_{{@key}}" value="-2" min="-2" />
		</div>
		<div class="{{@key}}-name">
			<span>{{capitalize @key}}</span>
		</div>
		<div class="{{@key}}-save">
			<span>Save</span>
			<input type="text" name="attr_{{@key}}Save" value="-2" readonly>
			<input type="checkbox" name="attr_{{@key}}SaveMastery" value="1" title="Save Mastery">
		</div>
		{{else}}
		<div class="prime-stat">
			<input type="text" name="attr_prime" value="-2" readonly>
		</div>
		<div class="prime-name">
			<span>Prime</span>
		</div>
		{{/if}}
		{{#each skills as |skill|}}
		{{#if skill}}
		<div class="{{skill}}-skill">
			<span>{{capitalize skill}}</span>
		</div>
		<div class="{{skill}}-masteries">
			{{else}}
			<div class="skill{{@index}}-skill">
				<input type="text" name="attr_skill{{@index}}Name">
			</div>
			<div class="skill{{@index}}-masteries">
				{{/if}}
				{{#each @root.masteries as |mastery|}}
				{{#if skill}}
				<input type="checkbox" name="attr_{{skill}}Mastery" value="{{mastery}}" title="{{capitalize @key}}">
				{{else}}
				<input type="checkbox" name="attr_skill{{@../index}}Mastery" value="{{mastery}}" title="{{capitalize @key}}">
				{{/if}}
				{{/each}}
			</div>
			{{#if skill}}
			<div class="{{skill}}-value">
				<input type="text" name="attr_{{skill}}" value="-2" readonly>
			</div>
			{{else}}
			<div class="skill{{@index}}-value">
				<input type="text" name="attr_skill{{@index}}" value="-2" readonly>
			</div>
			{{/if}}
			{{/each}}
			{{/each}}
		</div>

		{{!-- Character Trades --}}
		<div class="trades">
			<span>Trades</span>
			<fieldset class="repeating_trade">
				<input type="text" name="attr_tradeName" placeholder="Name">
				<select name="attr_tradeStat">
					<option value="none" selected disabled>Choose</option>
					{{#each stats}}
					<option value="{{this}}">{{capitalize this}}</option>
					{{/each}}
				</select>
				{{#each masteries}}
				<input type="checkbox" name="attr_tradeMastery" value="{{this}}" title="{{capitalize @key}}">
				{{/each}}
				<input type="text" name="attr_tradeModifier" value="0" readonly>
			</fieldset>
		</div>

		{{!-- Character Languages --}}
		<div class="languages">
			<span>Languages</span>
			<fieldset class="repeating_language">
				<select>
					<option value="none" selected disabled>Choose</option>
					{{#each language-lists as |list|}}
					<option disabled style="background: grey; font-weight: bold; color: white;">{{@key}}</option>
					{{#each list as |language|}}
					<option>{{titleize language}}</option>
					{{/each}}
					{{/each}}
				</select>
				{{#each language-masteries}}
				<input type="checkbox" title="{{capitalize this}}">
				{{/each}}
			</fieldset>
		</div>

		{{!-- Character Combat Masteries --}}
		<div class="combat-masteries">
			<span>Combat Masteries</span>
			<textarea></textarea>
		</div>

		{{!-- Character Currency --}}
		<div class="currency">
			<span>Currency</span>
			<textarea></textarea>
		</div>

		{{!-- Character Stamina, Mana, Hit Points, and Temporary Hit Points --}}
		<div class="points">
			{{#each points}}
			<span>{{capitalize this}} Points</span>
			<input type="number" name="attr_{{this}}Points" value="0">
			<span>Max</span>
			<input type="text" name="attr_{{this}}Points_max" value="0" readonly>
			{{/each}}

			<span>Temp</span>
			<input type="number" name="attr_tempHitPoints" value="0">
		</div>

		{{!-- Character Defenses --}}
		<div class="defenses">
			{{#each defenses}}
			<span>{{capitalize this}} Defense</span>
			<input type="text" name="attr_{{this}}Defense" value="0" readonly>
			<span>Heavy</span>
			<input type="text" name="attr_{{this}}Heavy" value="0" readonly>
			<span>Brutal</span>
			<input type="text" name="attr_{{this}}Brutal" value="0" readonly>
			<span>{{capitalize this}} Damage Reduction</span>
			<input type="number" name="attr_{{this}}DamageReduction" value="0">
			{{/each}}
		</div>

		{{!-- Character Combat Information --}}
		<div class="combat">
			<span>Combat</span>
			<span>Actions Points</span>
			<input type="checkbox">
			<input type="checkbox">
			<input type="checkbox">
			<input type="checkbox">
			<span>Minor Action Point</span>
			<input type="checkbox">
			<span>Attack/Spell Check</span>
			<input type="text" name="attr_attackModifier" value="-1" readonly>
		</div>

		{{!-- Character Attacks --}}
		<div class="attacks">
			<span>Attacks</span>
			<fieldset class="repeating_attack">
				<span>Name</span>
				<input type="text" name="attr_attackName" placeholder="Name">
				<span>Damage</span>
				<input type="number" name="attr_attackDamage" value="0" min="0">
				<span>Damage Type</span>
				<input type="text" name="attr_attackType" placeholder="Damage Type">
				<span>Special</span>
				<textarea></textarea>
			</fieldset>
		</div>

		{{!-- Character Inventory --}}
		<div class="inventory">
			<span>Inventory</span>
			<fieldset class="repeating_inventory">
				<span>Name</span>
				<input type="text" placeholder="Name">
				<span>Quantity</span>
				<input type="number" name="attr_inventoryQuantity" value="1" min="1">
				<span>Weight</span>
				<input type="number" name="attr_inventoryWeight" value="0" min="0">
			</fieldset>
		</div>

		{{!-- Character Death --}}
		<div class="death">
			<span>Death</span>
			<span>Exhaustion</span>
			<input type="hidden" name="attr_exhaustion" value="0">
			{{#each exhaustion}}
			<input type="checkbox" name="attr_exhaustion" value="{{this}}">
			{{/each}}
			<span>Death Threshold</span>
			<input type="text" name="attr_deathThreshold" value="0" readonly>
		</div>

		{{!-- Move and Jump --}}
		<div class="move">
			<span>Move Speed</span>
			<input type="number" name="attr_move" value="0" min="0">
			<span>Jump Distance</span>
			<input type="text" name="attr_jump" value="1" min="1" readonly>
		</div>

		{{!-- Resources --}}
		<div class="resources">
			<span>Resources</span>
			<span>Name</span>
			<span>Total</span>
			<span>Max</span>
			<span>Rest Points</span>
			<input type="number" name="attr_restPoints" value="0" min="0">
			<input type="text" name="attr_restPoints_max" value="0" readonly>
			<span>Grit Points</span>
			<input type="number" name="attr_gritPoints" value="0" min="0">
			<input type="text" name="attr_gritPoints_max" value="0" readonly>
			<fieldset class="repeating_resource">
				<input type="text" name="attr_resourceName" placeholder="Name">
				<input type="number" name="attr_resource" value="0" min="0">
				<input type="number" name="attr_resource_max" value="0">
			</fieldset>
		</div>

		{{!-- Character Features --}}
		<div class="features">
			<span>Features</span>
			<fieldset class="repeating_resource">
				<input type="text" placeholder="Name">
				<textarea></textarea>
			</fieldset>
		</div>
	</div>

	<script type="text/worker">
// COMBAT MASTERY and HIT POINTS
// When the level is changed, set the combat mastery
// When the level or might is changed, set the hit points
on("change:might change:level", () => {
	getAttrs(["level", "might"], values => {
		const level = +values.level || 0;
		const mastery = Math.ceil(level / 2);

		const might = +values.might || 0;
		const total = 6 + level + might;

		setAttrs({
			"combatMastery": mastery,
			"hitPoints_max": total
		});
	});
});

// STATS
// When the stats are changed, set the prime stat
on("change:might change:agility change:charisma change:intelligence", () => {
	getAttrs(["might", "agility", "charisma", "intelligence"], values => {
		const might = +values.might || 0;
		const agility = +values.agility || 0;
		const charisma = +values.charisma || 0;
		const intelligence = +values.intelligence || 0;
		const max = Math.max(might, agility, charisma, intelligence);

		setAttrs({
			"prime": max
		});
	});
});

// SAVES
// When the stats or save mastery is changed, set the save modifier
{{#each stats as |stat|}}
on("change:{{stat}}SaveMastery change:{{stat}}", () => {
	getAttrs(["{{stat}}", "combatMastery", "{{stat}}SaveMastery"], values => {
		const stat = +values.{{stat}} || 0;
		const cm = +values.combatMastery || 0;
		const sm = +values.{{stat}}SaveMastery || 0;
		let total = stat;

		if (sm == 1) {
			total = stat + cm;
		}

		setAttrs({
			{{stat}}Save: total
		});
	});
});
{{/each}}

// SKILLS
// When the stats or skill mastery is changed, set the skill modifier
{{#each skillsList as |skills|}}
	{{#each skills as |skill|}}
		{{#if @../key }}
on("change:{{skill}}Mastery change:{{@../key}}", () => {
	getAttrs(["{{skill}}Mastery", "{{@../key}}"], values => {
		const stat = +values.{{@../key}} || 0;
		const mastery = +values.{{skill}}Mastery || 0;
		const total = stat + mastery;

		setAttrs({
			"{{skill}}": total
		});
	});
});
		{{else}}
on("change:{{skill}}Mastery change:prime", () => {
	getAttrs(["{{skill}}Mastery", "{{@../key}}"], values => {
		const stat = +values.prime || 0;
		const mastery = +values.{{skill}}Mastery || 0;
		const total = stat + mastery;

		setAttrs({
			"{{skill}}": total
		});
	});
});
		{{/if}}
	{{/each}}
{{/each}}

// When custom skill mastery or intelligence is changed, set the custom skill modifiers
on("change:skill8Mastery change:skill9Mastery change:intelligence", () => {
	getAttrs(["skill8Mastery", "skill9Mastery", "intelligence"], values => {
		const mastery8 = +values.skill8Mastery || 0;
		const mastery9 = +values.skill9Mastery || 0;
		const intelligence = +values.intelligence || 0;
		const total8 = intelligence + mastery8;
		const total9 = intelligence + mastery9;

		setAttrs({
			"skill8": total8,
			"skill9": total9
		});
	});
});

// TRADES
// When the stats are changed, set the trades modifiers
on("change:might change:agility change:charisma change:intelligence", () => {
	getSectionIDs('repeating_trade', ids => {
		const trades = [];

		ids.forEach(id => trades.push({"stat": `repeating_trade_${id}_tradeStat`, "mastery": `repeating_trade_${id}_tradeMastery`, "mod": `repeating_trade_${id}_tradeModifier`}));

		for(let i = 0; i < trades.length; i++) {
			getAttrs([trades[i].stat, trades[i].mastery, trades[i].mod, "might", "agility", "charisma", "intelligence"], values => {
				const stat = values[trades[i].stat];
				const might = +values.might || 0;
				const agility = +values.agility || 0;
				const charisma = +values.charisma || 0;
				const intelligence = +values.intelligence || 0;
				const mastery = +values[trades[i].mastery] || 0;
				const total = stat == "might" ? might + mastery : stat == "agility" ? agility + mastery : stat == "charisma" ? charisma + mastery : intelligence + mastery;

				setAttrs({
					[trades[i].mod]: total
				});
			});
		}
	});
});

// When the trade stat or mastery is changed, set the trade modifier
on("change:repeating_trade:tradeStat change:repeating_trade:tradeMastery", () => {
	getAttrs(["repeating_trade_tradeStat"], values => {
		const stat = values.repeating_trade_tradeStat;

		getAttrs(["repeating_trade_tradeMastery", stat], values => {
			const statMod = +values[stat] || 0;
			const mastery = +values.repeating_trade_tradeMastery || 0;
			const total = statMod + mastery;

			setAttrs({
				"repeating_trade_tradeModifier": total
			});
		});
	});
});

// ATTACKS
// When prime or combat mastery is changed, set the attack modifier
on("change:prime change:combatMastery", () => {
	getAttrs(["prime", "combatMastery"], values => {
		const prime = +values.prime || 0;
		const cm = +values.combatMastery || 0;
		const total = prime + cm;

		setAttrs({
			"attackModifier": total
		});
	});
});

// DEFENSES
// When agility, armor bonus, or combat mastery is changed, set the physical defenses
on("change:agility change:armorBonus change:combatMastery", () => {
	getAttrs(["agility", "armorBonus", "combatMastery"], values => {
		const agility = +values.agility || 0;
		const armorBonus = +values.armorBonus || 0;
		const cm = +values.combatMastery || 0;
		const total = 8 + cm + agility + armorBonus;

		setAttrs({
			"physicalDefense": total,
			"physicalHeavy": total + 5,
			"physicalBrutal": total + 10
		});
	});
});

// When charisma, intelligence, or combat mastery is changed, set the mystical defenses
on("change:charisma change:intelligence change:combatMastery", () => {
	getAttrs(["charisma", "intelligence", "combatMastery"], values => {
		const charisma = +values.charisma || 0;
		const intelligence = +values.intelligence || 0;
		const cm = +values.combatMastery || 0;
		const total = 8 + cm + charisma + intelligence;

		setAttrs({
			"mysticalDefense": total,
			"mysticalHeavy": total + 5,
			"mysticalBrutal": total + 10
		});
	});
});

//DEATH
// When the prime is changed, set the death threshold
on("change:prime", () => {
	getAttrs(["prime"], values => {
		const prime = +values.prime || 0;
		let total = prime * -1;

		if (prime < 0) {
			total = 0;
		}

		setAttrs({
			"deathThreshold": total
		});
	});
});

// JUMP
// When the agility stat is changed, set the jump distance
on("change:agility", () => {
	getAttrs(["agility"], values => {
		const agility = +values.agility || 0;
		let total = agility;

		if (agility < 0) {
			total = 1;
		}

		setAttrs({
			"jump": total
		});
	});
});

// RESOURCES
// When the might stat or level is changed, set the rest points
on("change:might change:level", () => {
	getAttrs(["might", "level"], values => {
		const might = +values.might || 0;
		const level = +values.level || 0;
		let total = level + might;

		if (total < 0) {
			total = 0;
		}

		setAttrs({
			"restPoints_max": total
		});
	});
});

// When the charisma stat is changed, set the grit points
on("change:charisma", () => {
	getAttrs(["charisma"], values => {
		const charisma = +values.charisma || 0;
		const total = charisma + 2;

		setAttrs({
			"gritPoints_max": total
		});
	});
});
</script>