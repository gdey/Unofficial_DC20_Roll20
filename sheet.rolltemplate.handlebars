{{!-- {{#each tabs}}
<button type="action" name="act_{{this}}" class="tab">{{capitalize this}}</button>
{{/each}} --}}

{{!-- <input type="hidden" name="attr_character" class="toggle" value="1">
<div class="character toggled">
	Character
</div> --}}

{{!-- <input type="hidden" name="attr_npc" class="toggle" value="0">
<div class="npc toggled">
	NPC
</div> --}}

{{!-- <input type="hidden" name="attr_charmancer" class="toggle" value="0">
<div class="charmancer toggled">
	<h2>Attributes and Prime:</h2>
	<select name="attr_attributes">
		<option value="none" selected disabled>Choose</option>
		<option>Standard Array</option>
		<option>Point Buy</option>
		<option>Roll Method</option>
	</select>

	<input type="hidden" name="attr_array" class="toggle" value="0">
	<div class="toggled">
		{{#each stats}}
		<span>{{capitalize this}}</span>
		<select name="attr_{{this}}">
			<option value="none" selected disabled>Choose</option>
			<option>3</option>
			<option>1</option>
			<option>0</option>
			<option>-2</option>
		</select>
		{{/each}}
	</div>

	<input type="hidden" name="attr_buy" class="toggle" value="0">
	<div class="toggled">
		<span>Total Points:</span> <input type="number" name="attr_points" value="12" max="12" min="0">
		{{#each stats}}
		<span>{{capitalize this}}</span>
		<input type="number" name="attr_{{this}}" max="3" min="-2" value="-2">
		{{/each}}
	</div>

	<input type="hidden" name="attr_roll" class="toggle" value="0">
	<div class="toggled">Roll Method</div>
</div> --}}

<span>Player Name</span>
<input type="text" name="attr_playerName" placeholder="Enter Your Name">
<span>Character Name</span>
<input type="text" name="attr_character_name" placeholder="Enter Your Character's Name">
<span>Level</span>
<input type="number" name="attr_level" value="1">
<span>Combat Mastery</span>
<input type="text" name="attr_combatMastery" value="1" readonly>

{{#each skillsList as |skills|}}
<span>{{capitalize @key}}</span>
<input type="number" name="attr_{{@key}}" value="-2" min="-2" />
<span>Save</span>
<input type="number" name="attr_{{@key}}Save" value="-2" readonly>
<input type="checkbox" name="attr_{{@key}}SaveMastery" value="1">
{{#each skills as |skill|}}
{{#if skill}}
<span>{{capitalize skill}}</span>
{{else}}
<input type="text" name="attr_skill{{@index}}Name">
{{/if}}
{{#each @root.masteries as |mastery|}}
{{#if skill}}
<input type="checkbox" name="attr_{{skill}}Mastery" value="{{mastery}}">
{{else}}
<input type="checkbox" name="attr_skill{{@../index}}Mastery" value="{{mastery}}">
{{/if}}
{{/each}}
{{#if skill}}
<input type="number" name="attr_{{skill}}" value="-2" readonly>
{{else}}
<input type="number" name="attr_skill{{@index}}" value="-2" readonly>
{{/if}}
{{/each}}
{{/each}}

<span>Trades</span>
<fieldset class="repeating_trade">
	<input type="text" name="attr_tradeName" placeholder="Name">
	<select name="attr_tradeStat">
		<option value="none" selected disabled>Choose</option>
		{{#each stats}}
		<option value="{{this}}">{{capitalize this}}</option>
		{{/each}}
	</select>
	{{#each masteries}}
	<input type="checkbox" name="attr_tradeMastery" value="{{this}}">
	{{/each}}
	<input type="number" name="attr_tradeModifier" value="0" readonly>
</fieldset>

{{#each points}}
<span>{{capitalize this}} Points</span>
<input type="number" name="attr_{{this}}Points" value="0">
<span>Max</span>
<input type="number" name="attr_{{this}}Points_max" value="0" readonly>
{{/each}}

<span>Temp</span>
<input type="number" name="attr_tempHitPoints" value="0">

{{#each defenses}}
<span>{{capitalize this}} Defense</span>
<input type="number" name="attr_{{this}}Defense" value="0" readonly>
<span>Heavy</span>
<input type="number" name="attr_{{this}}Heavy" value="0" readonly>
<span>Brutal</span>
<input type="number" name="attr_{{this}}Brutal" value="0" readonly>
<span>{{capitalize this}} Damage Reduction</span>
<input type="number" name="attr_{{this}}DamageReduction" value="0">
{{/each}}

<script type="text/worker">
on("change:level", () => {
	getAttrs(["level"], values => {
		const level = +values.level || 1;
		const mastery = Math.ceil(level / 2);

		setAttrs({
			combatMastery: mastery
		});
	});
});

on("change:might change:agility change:charisma change:intelligence", () => {
	getSectionIDs('repeating_trade', ids => {
		const trades = [];

		ids.forEach(id => trades.push({"stat": `repeating_trade_${id}_tradeStat`, "mastery": `repeating_trade_${id}_tradeMastery`, "mod": `repeating_trade_${id}_tradeModifier`}));

		for(let i = 0; i < trades.length; i++) {
			getAttrs([trades[i].stat, trades[i].mastery, trades[i].mod, "might", "agility", "charisma", "intelligence"], values => {
				const stat = values[trades[i].stat];
				const might = +values.might || 0;
				const agility = +values.agility || 0;
				const charisma = +values.charisma || 0;
				const intelligence = +values.intelligence || 0;
				const mastery = +values[trades[i].mastery] || 0;
				const total = stat == "might" ? might + mastery : stat == "agility" ? agility + mastery : stat == "charisma" ? charisma + mastery : intelligence + mastery;
				console.log(mastery)
				setAttrs({
					[trades[i].mod]: total
				});
			});
		}
	});
});

on("change:might change:level", () => {
	getAttrs(["might", "level"], values => {
		const might = +values.might || 0;
		const level = +values.level || 1;
		const total = 6 + level + might;

		setAttrs({
			"hitPoints_max": total
		});
	});
});

on("change:agility change:armorBonus change:combatMastery", () => {
	getAttrs(["agility", "armorBonus", "combatMastery"], values => {
		const agility = +values.agility || 0;
		const armorBonus = +values.armorBonus || 0;
		const cm = +values.combatMastery || 0;
		const total = 8 + cm + agility + armorBonus;

		setAttrs({
			"physicalDefense": total,
			"physicalHeavy": total + 5,
			"physicalBrutal": total + 10
		});
	});
});

on("change:charisma change:intelligence change:combatMastery", () => {
	getAttrs(["charisma", "intelligence", "combatMastery"], values => {
		const charisma = +values.charisma || 0;
		const intelligence = +values.intelligence || 0;
		const cm = +values.combatMastery || 0;
		const total = 8 + cm + charisma + intelligence;

		setAttrs({
			"mysticalDefense": total,
			"mysticalHeavy": total + 5,
			"mysticalBrutal": total + 10
		});
	});
});

on("change:skill7Mastery change:intelligence", () => {
	getAttrs(["skill7Mastery", "intelligence"], values => {
		const mastery = +values.skill7Mastery || 0;
		const intelligence = +values.intelligence || 0;
		const total = intelligence + mastery;

		setAttrs({
			"skill7": total
		});
	});
});

on("change:skill8Mastery change:intelligence", () => {
	getAttrs(["skill8Mastery", "intelligence"], values => {
		const mastery = +values.skill8Mastery || 0;
		const intelligence = +values.intelligence || 0;
		const total = intelligence + mastery;

		setAttrs({
			"skill8": total
		});
	});
});

{{#each skillsList as |skills|}}
	on("change:{{@key}}SaveMastery change:{{@key}}", () => {
		getAttrs(["{{@key}}", "combatMastery", "{{@key}}SaveMastery"], values => {
			const stat = +values.{{@key}} || 0;
			const cm = +values.combatMastery || 0;
			const sm = +values.{{@key}}SaveMastery || 0;
			let total = stat;

			if (sm == 1) {
				total = stat + cm;
			}

			setAttrs({
				"{{@key}}Save": total
			});
		});
	});
{{/each}}

{{#each skillsList as |skills|}}
	{{#each skills as |skill|}}
		on("change:{{skill}}Mastery change:{{@../key}}", () => {
			getAttrs(["{{skill}}Mastery", "{{@../key}}"], values => {
				const stat = +values.{{@../key}} || 0;
				const mastery = +values.{{skill}}Mastery || 0;
				const total = stat + mastery;

				setAttrs({
					"{{skill}}": total
				});
			});
		});
	{{/each}}
{{/each}}

on("change:repeating_trade:tradeStat change:repeating_trade:tradeMastery", () => {
	getAttrs(["repeating_trade_tradeStat"], values => {
		const stat = values.repeating_trade_tradeStat || "";

		getAttrs(["repeating_trade_tradeMastery", stat], values => {
			const statMod = +values[stat] || 0;
			const mastery = +values.repeating_trade_tradeMastery || 0;
			const total = statMod + mastery;

			setAttrs({
				"repeating_trade_tradeModifier": total
			});
		});
	});
});

function section_name(section, id, field) {
	return `repeating_${section}_${id}_${field}`;
}

//	on("clicked:character clicked:charmancer clicked:npc", eventInfo => {
//		getAttrs(["character", "charmancer", "npc"], values => {
//			const character = values.character;
//			const charmancer = values.charmancer;
//			const npc = values.npc;
//			const trigger = eventInfo.triggerName;
//			let output = {};
//
//			{{#each tabs}}
//					output.{{this}} = trigger.includes("{{this}}") ? 1 : 0
//			{{/each}}
//
//			setAttrs(output);
//		});
//	});

	//on('change:attributes', () => {
		//getAttrs(['attributes'], values => {
			//const method = values.attributes;

			//setAttrs({
				//array: method === 'Standard Array' ? 1 : 0,
				//buy: method === 'Point Buy' ? 1 : 0,
				//roll: method === 'Roll Method' ? 1 : 0,
				//might: method === 'Point Buy' ? -2 : "none",
				//agility: method === 'Point Buy' ? -2 : "none",
				//intelligence: method === 'Point Buy' ? -2 : "none",
				//charisma: method === 'Point Buy' ? -2 : "none",
				//points: method === 'Point Buy' ? 12 : 0
			//});
		//});
	//});

//	{{#each stats}}
//		on('change:{{this}}', eventInfo => {
//			getAttrs(['points', {{this}}], values => {
//				console.log(eventInfo.previousValue, values.{{this}})
//				const {{this}} = +values.{{this}} || 0;
//				const previous = +eventInfo.previousValue || 0;
//				const difference = previous - {{this}};
//				const points = +values.points || 0;
//				const total = points - difference;
//
//				setAttrs({
//					points: total
//				});
//			});
//		});
//	{{/each}}
</script>

{{!--
EACH - THIS
<div>
	{{#each stats}}
	<span>{{this}}</span>
	<input type='number' name='attr_{{this}}' value='10' />
	<input type='number' name='attr_{{this}}_buff' value='0' />
	<input type='number' name='attr_{{this}}_modifier' value='0' />
	{{/each}}
</div>

EACH - @KEY - AS - EQ - @ROOT
<div>
	{{#each skills as |skill|}}
	<span>{{@key}}</span>
	<select name="attr_{{@key}}_skill">
		{{#each @root.stats as |stat|}}
		<option {{#eq skill stat}}selected{{/eq}}>{{this}}</option>
		{{/each}}
	</select>
	<input type="checkbox" name="attr_{{@key}}_trained" value="1">
	<input type="number" name="attr_{{@key}}_special" value="0">
	<input type="number" name="attr_{{@key}}_modifier" value="0">
	{{/each}}
</div>

NOOP
<div>
	{{{{noop}}}}
	&{template}{{name=Monster}}
	{{{{/noop}}}}
</div>


<script type="text/worker">
{{#each stats}}
	on('change:{{this}} change:{{this}}_buff', () => {
			getAttrs(['{{this}}', '{{this}}_buff'], values => {
				const score = +values.{{this}} || 0;
				const buff = +values.{{this}}_buff || 0;
				const base_mod = Math.floor(score/2) -5;
				const total = base_mod + buff;
				setAttrs({
					{{this}}_modifier: total
				});
			});
	});
{{/each}}

{{#each skills as |skill|}}
	on('change:{{@key}}_trained change:{{@key}}_special sheet:opened', () => {
		getAttrs(['{{@key}}_trained', '{{@key}}_special'], values => {
				const score = +values.{{@key}}_trained || 0;
				const score_trained = score * 4;
				const special = +values.{{@key}}_special || 0;
				const total = score_trained + special;
				setAttrs({
						{{@key}}_modifier: total
				});
		});
	});
{{/each}}
</script>
--}}